export default function (view) {
  view.addEventListener("viewshow", () => import(
    ApiClient.getUrl("web/ConfigurationPage", {
      name: "Xtream.js",
    })
  ).then((Xtream) => Xtream.default
  ).then((Xtream) => {
    const pluginId = Xtream.pluginConfig.UniqueId;
    Xtream.setTabs(4);

    const getConfig = ApiClient.getPluginConfiguration(pluginId);
    const visible = view.querySelector("#Visible");
    const flattenSeriesView = view.querySelector("#FlattenSeriesView");
    const enableCaching = view.querySelector("#EnableCaching");
    const cacheOptionsContainer = view.querySelector("#CacheOptionsContainer");
    const cacheRefreshMinutes = view.querySelector("#SeriesCacheRefreshMinutes");
    const refreshCacheBtn = view.querySelector("#RefreshCacheBtn");
    const clearCacheBtn = view.querySelector("#ClearCacheBtn");
    const cacheStatusContainer = view.querySelector("#CacheStatusContainer");
    const cacheProgressFill = view.querySelector("#CacheProgressFill");
    const cacheStatusText = view.querySelector("#CacheStatusText");

    // Toggle cache options visibility
    function updateCacheOptionsVisibility() {
      cacheOptionsContainer.style.display = enableCaching.checked ? 'block' : 'none';
    }

    enableCaching.addEventListener('change', updateCacheOptionsVisibility);

    getConfig.then((config) => {
      visible.checked = config.IsSeriesVisible;
      flattenSeriesView.checked = config.FlattenSeriesView || false;
      enableCaching.checked = config.EnableSeriesCaching !== false; // Default to true for backwards compatibility
      cacheRefreshMinutes.value = config.SeriesCacheExpirationMinutes || 600;
      updateCacheOptionsVisibility();
    });

    // Refresh Now button handler
    refreshCacheBtn.addEventListener('click', () => {
      // Check if already refreshing
      if (refreshCacheBtn.disabled) {
        Dashboard.alert('Cache refresh is already in progress. Please wait for it to complete.');
        return;
      }

      refreshCacheBtn.disabled = true;
      refreshCacheBtn.querySelector('span').textContent = 'Starting...';

      fetch(ApiClient.getUrl('Xtream/SeriesCacheRefresh'), {
        method: 'POST',
        headers: ApiClient.defaultRequestHeaders()
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('Server returned ' + response.status);
          }
          return response.json();
        })
        .then(result => {
          if (result.Success) {
            cacheStatusText.textContent = 'Refresh started...';
            cacheStatusText.style.color = '#00a4dc';
            cacheStatusContainer.style.display = 'block';
          } else {
            Dashboard.alert(result.Message || 'Failed to start refresh');
          }
        })
        .catch(err => {
          console.error('Failed to trigger cache refresh:', err);
          Dashboard.alert('Failed to trigger cache refresh: ' + err.message);
        })
        .finally(() => {
          refreshCacheBtn.disabled = false;
          refreshCacheBtn.querySelector('span').textContent = 'Refresh Now';
        });
    });

    // Clear Cache button handler
    clearCacheBtn.addEventListener('click', () => {
      // Check if a refresh is currently running
      Xtream.fetchJson('Xtream/SeriesCacheStatus')
        .then((status) => {
          let confirmMessage = 'Are you sure you want to clear the cache? Next refresh will fetch all data from scratch.';
          if (status.IsRefreshing) {
            confirmMessage = 'A cache refresh is currently in progress. Clearing the cache will stop the refresh. Are you sure you want to continue?';
          }

          if (!confirm(confirmMessage)) {
            return;
          }

          clearCache();
        });
    });

    function clearCache() {

      clearCacheBtn.disabled = true;
      clearCacheBtn.querySelector('span').textContent = 'Clearing...';

      fetch(ApiClient.getUrl('Xtream/SeriesCacheClear'), {
        method: 'POST',
        headers: ApiClient.defaultRequestHeaders()
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('Server returned ' + response.status);
          }
          return response.json();
        })
        .then(result => {
          if (result.Success) {
            Dashboard.alert('Cache cleared successfully');
            cacheStatusText.textContent = 'Cache cleared';
            cacheStatusText.style.color = '#a0a0a0';
            cacheProgressFill.style.width = '0%';
          } else {
            Dashboard.alert(result.Message || 'Failed to clear cache');
          }
        })
        .catch(err => {
          console.error('Failed to clear cache:', err);
          Dashboard.alert('Failed to clear cache: ' + err.message);
        })
        .finally(() => {
          clearCacheBtn.disabled = false;
          clearCacheBtn.querySelector('span').textContent = 'Clear Cache';
        });
    }

    // Poll cache status every 2 seconds
    let statusPollInterval;
    function updateCacheStatus() {
      Xtream.fetchJson('Xtream/SeriesCacheStatus')
        .then((status) => {
          if (status.IsRefreshing || status.Progress > 0 || status.IsCachePopulated) {
            cacheStatusContainer.style.display = 'block';
            const progressPercent = Math.round(status.Progress * 100);
            cacheProgressFill.style.width = progressPercent + '%';
            cacheStatusText.textContent = status.Status || 'Idle';

            if (status.IsRefreshing) {
              cacheStatusText.style.color = '#00a4dc';
              refreshCacheBtn.disabled = true;
              // Clear Cache button stays enabled - it will cancel the refresh
            } else {
              refreshCacheBtn.disabled = false;
              if (status.Progress >= 1.0) {
                cacheStatusText.style.color = '#4caf50';
              } else {
                cacheStatusText.style.color = '#a0a0a0';
              }
            }
          } else {
            cacheStatusContainer.style.display = 'none';
            refreshCacheBtn.disabled = false;
          }
        })
        .catch(() => {
          // Silently fail if API is not available
        });
    }

    // Start polling when view is shown
    updateCacheStatus();
    statusPollInterval = setInterval(updateCacheStatus, 2000);

    // Clean up interval when view is hidden
    view.addEventListener("viewhide", () => {
      if (statusPollInterval) {
        clearInterval(statusPollInterval);
      }
    });
    const table = view.querySelector('#SeriesContent');
    Xtream.populateCategoriesTable(
      table,
      () => getConfig.then((config) => config.Series),
      () => Xtream.fetchJson('Xtream/SeriesCategories'),
      (categoryId) => Xtream.fetchJson(`Xtream/SeriesCategories/${categoryId}`),
    ).then((data) => {
      view.querySelector('#XtreamSeriesForm').addEventListener('submit', (e) => {
        Dashboard.showLoadingMsg();

        ApiClient.getPluginConfiguration(pluginId).then((config) => {
          config.IsSeriesVisible = visible.checked;
          config.FlattenSeriesView = flattenSeriesView.checked;
          config.EnableSeriesCaching = enableCaching.checked;

          // Validate refresh frequency (min: 10, max: 1380 to prevent exceeding 24h cache expiration)
          let refreshMinutes = parseInt(cacheRefreshMinutes.value, 10) || 600;
          if (refreshMinutes < 10) refreshMinutes = 10;
          if (refreshMinutes > 1380) refreshMinutes = 1380;
          config.SeriesCacheExpirationMinutes = refreshMinutes;

          config.Series = data;
          ApiClient.updatePluginConfiguration(pluginId, config).then((result) => {
            Dashboard.processPluginConfigurationUpdateResult(result);
          });
        });

        e.preventDefault();
        return false;
      });
    }).catch((error) => {
      console.error('Failed to load series categories:', error);
      Dashboard.hideLoadingMsg();
      // Clear any previous content/errors before showing new error
      table.innerHTML = '';
      const errorRow = document.createElement('tr');
      const errorCell = document.createElement('td');
      errorCell.colSpan = 3;
      errorCell.style.color = '#ff6b6b';
      errorCell.style.padding = '16px';
      errorCell.innerHTML = 'Failed to load categories. Please check:<br>' +
        '1. Xtream credentials are configured (Credentials tab)<br>' +
        '2. Xtream server is accessible<br>' +
        '3. Browser console for detailed errors';
      errorRow.appendChild(errorCell);
      table.appendChild(errorRow);
    });
  }));
}
